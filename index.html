<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Water Level</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e6f7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .tank-container {
      position: relative;
      width: 120px;
      height: 300px;
      border: 4px solid #333;
      background: #fff;
      overflow: hidden;
      margin-top: 20px;
    }
    .fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 0;
      background: linear-gradient(to top, #00ff00, #66ccff, #ffff00, #ff0000);
      transition: height 1s ease;
      z-index: 0;
    }
    .segments {
      position: absolute;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }
    .segment {
      flex: 1;
      border-bottom: 2px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1em;
      color: white;
      transition: color 0.3s;
    }
    .active {
      color: #fff;
    }
    .inactive {
      color: #bbb;
    }
    .spinner {
      border: 5px solid #ccc;
      border-top: 5px solid #333;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 15px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .status {
      margin-top: 10px;
      font-size: 1em;
    }
    .mode {
      margin-top: 5px;
      font-size: 0.9em;
      color: #444;
    }
  </style>
</head>
<body>
  <h1>Water Level</h1>

  <div class="tank-container">
    <div class="fill" id="fill"></div>
    <div class="segments">
      <div id="seg100" class="segment inactive">100%</div>
      <div id="seg75" class="segment inactive">75%</div>
      <div id="seg50" class="segment inactive">50%</div>
      <div id="seg25" class="segment inactive">25%</div>
    </div>
  </div>

  <div class="spinner"></div>
  <div class="status" id="lastUpdate">Loading...</div>
  <div class="mode" id="modeLabel">Startup Mode</div>

  <script>
    const channelID = 3026172;
    const readAPIKey = "AHHPO1T2TZDGZ2G8";

    async function fetchLatestValue() {
      const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=4&api_key=${readAPIKey}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.feeds;
    }

    function updateTank(level) {
      const segments = {
        100: document.getElementById('seg100'),
        75: document.getElementById('seg75'),
        50: document.getElementById('seg50'),
        25: document.getElementById('seg25')
      };

      [100, 75, 50, 25].forEach(val => {
        segments[val].classList.remove('active', 'inactive');
        segments[val].classList.add(val <= level ? 'active' : 'inactive');
      });

      const fill = document.getElementById('fill');
      let fillHeight = 0;
      if (level === 100) fillHeight = 100;
      else if (level === 75) fillHeight = 75;
      else if (level === 50) fillHeight = 50;
      else if (level === 25) fillHeight = 25;
      else fillHeight = 0;

      fill.style.height = `${fillHeight}%`;
    }

    function secondsSince(dateStr) {
      const then = new Date(dateStr);
      const now = new Date();
      return Math.floor((now - then) / 1000);
    }

    function isStartupMode(values) {
      const levels = values.map(v => parseInt(v.field1));
      return levels.join(',') === "25,50,75,100";
    }

    async function refresh() {
      const feeds = await fetchLatestValue();
      const latest = feeds[feeds.length - 1];
      const level = parseInt(latest.field1);
      const time = latest.created_at;
      const secsAgo = secondsSince(time);

      updateTank(level);
      document.getElementById('lastUpdate').innerText = `Updated ${secsAgo} seconds ago`;

      const modeLabel = document.getElementById('modeLabel');
      if (isStartupMode(feeds)) {
        modeLabel.innerText = "Startup Mode";
      } else {
        modeLabel.innerText = "Live Mode";
      }
    }

    refresh();
    setInterval(refresh, 15000);
  </script>
</body>
</html>

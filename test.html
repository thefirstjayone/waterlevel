<script>
    const channelID = "3026172"; // ThingSpeak Channel ID
    const readAPIKey = "AHHPO1T2TZDGZ2G8"; // ThingSpeak Read API Key

    let lastUpdateTime = null;

    function updateTank(level) {
        const waterDiv = document.getElementById("water");
        const levelText = document.getElementById("levelText");

        // Set height of water
        waterDiv.style.height = `${level}%`;

        // Show special message if exactly 2%
        if (level === 2) {
            levelText.textContent = "Colour Sensor Not Detected";
        } else {
            levelText.textContent = `${level}%`;
        }

        // Remove all color classes
        waterDiv.className = "water";

        // Set color based on level
        if (level >= 100) {
            waterDiv.classList.add("green");
        } else if (level >= 75) {
            waterDiv.classList.add("blue");
        } else if (level >= 50) {
            waterDiv.classList.add("yellow");
        } else if (level >= 25) {
            waterDiv.classList.add("red");
        } else {
            waterDiv.classList.add("red", "flash");
        }
    }

    function fetchLevel() {
        const url = `https://api.thingspeak.com/channels/${channelID}/fields/1/last.json?api_key=${readAPIKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const level = parseFloat(data.field1) || 0;
                updateTank(level);
                lastUpdateTime = Date.now();
            })
            .catch(error => {
                console.error("Error fetching data:", error);
            });
    }

    function updateTimeSince() {
        const updateTimeDiv = document.getElementById("updateTime");
        if (lastUpdateTime) {
            const secondsAgo = Math.floor((Date.now() - lastUpdateTime) / 1000);
            updateTimeDiv.textContent = `Last updated: ${secondsAgo} second${secondsAgo !== 1 ? 's' : ''} ago`;
        }
    }

    fetchLevel();
    setInterval(fetchLevel, 20000);
    setInterval(updateTimeSince, 1000);
</script>

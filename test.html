<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zach & Jarrett's Water Tank Level</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background-color: #121212;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 {
    margin-top: 20px;
    font-size: 2em;
    line-height: 1.2em;
  }
  .tank-container {
    position: relative;
    margin: 30px auto;
    width: 200px;
    height: 400px;
    background: #333;
    border-radius: 20px;
    overflow: hidden;
    border: 4px solid #555;
    box-shadow: 0 0 15px rgba(0,0,0,0.8);
  }
  .water {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 0%;
    background: rgba(0, 150, 255, 0.5);
    animation: rise 1.5s ease-out forwards;
    clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%);
  }
  .wave {
    position: absolute;
    top: -10px;
    left: 0;
    width: 200%;
    height: 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 100%;
    animation: wave 4s infinite linear;
  }
  @keyframes wave {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  @keyframes rise {
    from { height: var(--prev-height, 0%); }
    to { height: var(--target-height); }
  }
  .warning {
    color: red;
    font-weight: bold;
    margin-top: 10px;
    animation: flash 1s infinite;
  }
  @keyframes flash {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
  }
</style>
</head>
<body>

<h1>
  Zach &amp; Jarrett's<br>
  Water Tank Level
</h1>

<div class="tank-container">
  <div class="water" id="water">
    <div class="wave"></div>
  </div>
</div>

<div id="level-text">Loading...</div>
<div id="sensor-warning"></div>
<div id="last-update">Time since last update: 0s</div>

<script>
const channelID = "3026172";
const readAPIKey = "AHHPO1T2TZDGZ2G8";
let lastUpdateTime = Date.now();
let prevHeight = 0;

function fetchLevel() {
  fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1/last.json?api_key=${readAPIKey}`)
    .then(response => response.json())
    .then(data => {
      let level = parseFloat(data.field1);
      if (isNaN(level)) level = 0;
      
      updateTank(level);
      lastUpdateTime = Date.now();
    })
    .catch(err => {
      console.error("Error fetching data", err);
    });
}

function updateTank(level) {
  const water = document.getElementById('water');
  const levelText = document.getElementById('level-text');
  const warning = document.getElementById('sensor-warning');
  
  levelText.textContent = `Water Level: ${level}%`;
  
  if (level === 2) {
    warning.textContent = "Colour Sensor Not Detected";
  } else {
    warning.textContent = "";
  }
  
  // Change colour based on level
  let colour;
  if (level >= 100) colour = "rgba(0,255,0,0.5)";
  else if (level >= 75) colour = "rgba(0,150,255,0.5)";
  else if (level >= 50) colour = "rgba(255,255,0,0.5)";
  else if (level >= 25) colour = "rgba(255,0,0,0.5)";
  else colour = "rgba(255,0,0,0.5)";
  
  water.style.setProperty('--prev-height', prevHeight + "%");
  water.style.setProperty('--target-height', level + "%");
  water.style.background = colour;
  prevHeight = level;
}

setInterval(() => {
  const seconds = Math.floor((Date.now() - lastUpdateTime) / 1000);
  document.getElementById('last-update').textContent = `Time since last update: ${seconds}s`;
}, 1000);

fetchLevel();
setInterval(fetchLevel, 15000);
</script>

</body>
</html>
